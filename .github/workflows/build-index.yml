# .github/workflows/build-index.yml
# Main workflow to build and deploy the package index

name: Build Package Index

on:
  # Trigger when any NodeTool package creates a release
  repository_dispatch:
    types: [package-released]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild entire index'
        required: false
        default: 'false'
        type: boolean
  
  # Scheduled rebuild (daily)
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily

jobs:
  build-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout nodetool-registry
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests packaging jinja2
          
      - name: Build package index
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_REBUILD: ${{ github.event.inputs.force_rebuild }}
        run: |
          python scripts/build_index.py --output-dir dist --github-token ${{ secrets.GITHUB_TOKEN }}
          
      - name: Generate index metadata
        run: |
          python scripts/generate_metadata.py --output-dir dist
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: nodetool-registry.github.io
          
      - name: Create deployment summary
        run: |
          echo "## Package Index Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🚀 **Deployment**: Success" >> $GITHUB_STEP_SUMMARY
          echo "📦 **Index URL**: https://nodetool-ai.github.io/nodetool-registry/simple/" >> $GITHUB_STEP_SUMMARY
          echo "⏰ **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count packages in index
          PACKAGE_COUNT=$(find dist -name "index.html" -not -path "*/index.html" | wc -l)
          echo "📋 **Packages**: $PACKAGE_COUNT" >> $GITHUB_STEP_SUMMARY